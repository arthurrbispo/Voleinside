<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="icon" href="./assets/imgs/voleinside/Icon/Logo-_FF5500.ico" />
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vôleinside | Dashboards</title>


    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<!-- <body onload=" atualizarFeed()"> -->

<body onload="nome(), obterDadosGrafico()">

    <div class="janela">
        <div class="header-left">
            <img src="./assets/imgs/voleinside/logo-laranja-azul-title.png" class="titulo">

            <div class="hello">
                <h2>Olá, <span id="b_usuario"></span>!</h2>
            </div> <br><br>
            <div class="text-nav">
                <h2>Quer continuar vendo suas estatisticas?<br>                
                </h2>
                <a href="./questionario.html">
                    <h3>Preencher questionário</h3>
                </a>
            </div>
            <div class="nav"><img src="./assets/imgs/voleinside/voleinsidelogin.png" alt="">
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>

        
        <div class="dash">
            <div class="kpi">
                <div class="kpi-box">
                    <div class="kpi-text">Sua dupla</div>
                    <div class="kpi-value" id="statusJogo"></div>
                    <div class="kpi-text">o jogo.</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-text">Aproveitamento da dupla</div>
                    <div class="kpi-value" id="aproveitDupla"></div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-text">Aproveitamento individual</div>
                    <div class="kpi-value" id="aproveitSolo"></div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-text">Seus pontos na ultima partida</div>
                    <div class="kpi-value" id="pontosSolo"></div>
                </div>
            </div>

            <div class="charts">
                <div class="chart">
                    <div class="chart-title">Pontos feitos nas ultimas partidas</div>
                    <div class="chart-pontos">
                        <canvas id="graficoPontos"></canvas>
                    </div>   
                </div>
            
                <div class="chart">
                    <div class="chart-title">Seu aproveitamento nas ultimas partidas(%)</div>
                    <div class="chart-pontos">
                        <canvas id="graficoAproveitamento"></canvas>
                    </div>   
                </div>
            </div>
        </div>
    </div>



</body>

</html>

<script>

    function nome() {
        var nomeUser = sessionStorage.NOME_USUARIO;
        b_usuario.innerHTML = nomeUser;

    }
    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function obterDadosGrafico() {
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/medidas/ultimas/${idUsuario}`, { cache: 'no-store' })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                        plotarGraficoPontos(resposta);
                        plotarGraficoAproveitamento(resposta);
                        plotarKPI(resposta);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*

function plotarKPI(resposta) {
    aproveitDupla.innerHTML = `${resposta[0].aproveitTotal}%`;
    aproveitSolo.innerHTML = `${resposta[0].aprovetProprio}%`;
    pontosSolo.innerHTML = `${resposta[0].pontosProprios}`;

    if ((resposta[0].pontosDupla == 21 && (resposta[0].setJogo == 1 || resposta[0].setJogo == 2)) || (resposta[0].setJogo == 3 && resposta[0].pontosDupla > resposta[0].pontosSofridos)) {
        statusJogo.innerHTML = `<span style="color: green;">VENCEU</span>`
    } else {
        statusJogo.innerHTML = `<span style="color: red;">PERDEU</span>`
    }
}

function plotarGraficoPontos(resposta) {


    console.log('Iniciando plotagem do gráfico de PONTOS...');

    resposta = [...resposta].reverse();

    let labels = [];
    let dadosPontos = [];

    resposta.forEach(registro => {
        labels.push(registro.momento_grafico || `Set ${registro.setJogo}`);
        dadosPontos.push(registro.pontosProprios);
    });

    console.log('----------------------------------------------');
    console.log('Dados do gráfico de pontos:');
    console.log(labels, dadosPontos);
    console.log('----------------------------------------------');

    const dados = {
        labels: labels,
        datasets: [{
            label:"",
            data: dadosPontos,
            fill: false,
            borderColor: '#ff7232',
            backgroundColor: '#ff7232',
            tension: 0.1,
        }]
    };

    const config = {
        type: 'line',
        data: dados,
            options: {
        scales: {
            y: {
                min: 0,
                max: 22,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
    };

    new Chart(
        document.getElementById('graficoPontos'),
        config
    );
}

function plotarGraficoAproveitamento(resposta) {

    console.log('Iniciando plotagem do gráfico de APROVEITAMENTO...');

    resposta = [...resposta].reverse();

    let labels = [];
    let dadosAproveitamento = [];

    resposta.forEach(registro => {
        labels.push(registro.momento_grafico || `Set ${registro.setJogo}`);
        dadosAproveitamento.push(registro.aprovetProprio);
    });

    console.log('----------------------------------------------');
    console.log('Dados do gráfico de aproveitamento:');
    console.log(labels, dadosAproveitamento);
    console.log('----------------------------------------------');

    const dados = {
        labels: labels,
        datasets: [{
            label: '',
            data: dadosAproveitamento,
            backgroundColor: '#FF5500',

        }]
    };

    const config = {
        type: 'bar',
        data: dados
    };

    new Chart(
        document.getElementById('graficoAproveitamento'),
        config
    );
}




</script>